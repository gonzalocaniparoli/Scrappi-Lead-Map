<!DOCTYPE html>
<html>
<head>
    <title>scRappi BI - Mobile Pro</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        #map { height: 100vh; width: 100%; background: #f0f2f5; }
        body { margin: 0; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        .legend { 
            background: rgba(255, 255, 255, 0.95); padding: 8px; border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 11px; line-height: 1.3;
            backdrop-filter: blur(5px); border: 1px solid #e2e8f0; max-width: 140px;
        }
        
        /* Bot√≥n de Ubicaci√≥n */
        .locate-btn {
            background: #fff; width: 40px; height: 40px; line-height: 40px;
            text-align: center; border-radius: 50%; cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 20px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #6366f1; color: #6366f1; font-weight: bold;
        }

        .popup-card { min-width: 180px; max-width: 200px; padding: 2px; }
        .popup-header { border-bottom: 1px solid #f1f5f9; padding-bottom: 4px; margin-bottom: 6px; }
        .popup-title { font-size: 13px; color: #1e293b; font-weight: 700; display: block; margin-bottom: 2px; line-height: 1.2; }
        .popup-badge { background: #f1f5f9; color: #64748b; font-size: 9px; padding: 1px 6px; border-radius: 4px; font-weight: 600; }
        .popup-text { margin: 2px 0; font-size: 11px; color: #64748b; line-height: 1.2; }
        
        .btn-wa { 
            display: block; background: #25d366; color: white !important; 
            padding: 6px; border-radius: 6px; text-decoration: none; 
            font-weight: bold; margin-top: 8px; font-size: 11px; text-align: center; 
        }
        
        .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        
        #catFilter { 
            width: 100%; padding: 4px; margin-top: 5px; border-radius: 4px; 
            border: 1px solid #cbd5e1; font-size: 11px; outline: none;
        }

        .leaflet-popup-content-wrapper { border-radius: 8px; padding: 0; }
        .leaflet-popup-content { margin: 8px; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="mapa_leads.js"></script>

    <script>
        const map = L.map('map', { zoomControl: false }).setView([0, 0], 2);
        L.control.zoom({ position: 'bottomleft' }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        const heatLayer = L.heatLayer([], { radius: 18, blur: 12 }).addTo(map);
        
        const sleep = ms => new Promise(res => setTimeout(res, ms));

        // --- L√ìGICA DE GEOLOCALIZACI√ìN ---
        let userMarker = null;

        const locateControl = L.control({ position: 'bottomright' });
        locateControl.onAdd = function() {
            const div = L.DomUtil.create('div', 'locate-btn');
            div.innerHTML = 'üìç'; 
            div.onclick = function(e) {
                e.stopPropagation();
                map.locate({ setView: true, maxZoom: 16 });
            };
            return div;
        };
        locateControl.addTo(map);

        map.on('locationfound', (e) => {
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker(e.latlng, {
                radius: 10, fillColor: '#3b82f6', color: '#fff', weight: 3, fillOpacity: 1
            }).addTo(map).bindPopup("Est√°s aqu√≠").openPopup();
        });

        map.on('locationerror', () => alert("No pudimos encontrar tu ubicaci√≥n. Activ√° el GPS."));
        // ---------------------------------

        function getGeoContext(url) {
            if (url.includes(".com.ar")) return ", Argentina";
            if (url.includes(".com.uy")) return ", Uruguay";
            if (url.includes(".com.mx") || url.includes("ubereats.com")) return ", Mexico";
            if (url.includes("didiglobal.com/co")) return ", Colombia";
            return "";
        }

        function getWaLink(phone) {
            if (!phone) return null;
            let clean = phone.replace(/\D/g, ''); 
            if (clean.length < 8) return null;
            return `https://wa.me/${clean}`;
        }

        function createMarker(lat, lng, shop) {
            const rating = parseFloat(shop.RATING || 0);
            const color = rating >= 4.5 ? '#22c55e' : rating >= 4.0 ? '#eab308' : '#ef4444';
            const waLink = getWaLink(shop.PHONE);
            
            let rawCats = shop.CATEGORIES || "Sin Rubro";
            if (Array.isArray(rawCats)) rawCats = rawCats[0];

            const marker = L.circleMarker([lat, lng], {
                radius: 7, fillColor: color, color: "#fff", weight: 1.5, fillOpacity: 0.9
            });

            let popupContent = `
                <div class="popup-card">
                    <div class="popup-header">
                        <span class="popup-title">${shop.NAME || 'Tienda'}</span>
                        <span class="popup-badge">${rawCats}</span>
                    </div>
                    <p class="popup-text">üìç ${shop.ADDRESS || 'Sin direcci√≥n'}</p>
                    <p class="popup-text">‚≠ê <b>${rating}</b> (${shop.REVIEWS || 0})</p>
                    ${waLink ? `<a href="${waLink}" target="_blank" class="btn-wa">üì± WhatsApp</a>` : ''}
                </div>
            `;
            return marker.bindPopup(popupContent);
        }

        async function render(selectedCat = "all") {
            map.eachLayer(layer => { if (layer instanceof L.CircleMarker && layer !== userMarker) map.removeLayer(layer); });
            if (typeof window.SCRAPED_LEADS === 'undefined') return;
            let firstPoint = false;
            let heatData = [];

            for (const shop of window.SCRAPED_LEADS) {
                let rawCats = shop.CATEGORIES || "";
                if (Array.isArray(rawCats)) rawCats = rawCats.join(", ");
                const shopCats = rawCats.toLowerCase();
                if (selectedCat !== "all" && !shopCats.includes(selectedCat.toLowerCase())) continue;

                let lat = parseFloat(shop.LAT || shop.lat || shop.latitude || 0);
                let lng = parseFloat(shop.LNG || shop.lng || shop.longitude || 0);

                if (!isNaN(lat) && !isNaN(lng) && lat !== 0) {
                    if (!firstPoint && !userMarker) { map.setView([lat, lng], 14); firstPoint = true; }
                    createMarker(lat, lng, shop).addTo(map);
                    heatData.push([lat, lng, 0.6]); 
                } 
            }
            heatLayer.setLatLngs(heatData);
        }

        const filterControl = L.control({ position: 'topright' });
        filterControl.onAdd = function() {
            const div = L.DomUtil.create('div', 'legend');
            let cats = new Set();
            window.SCRAPED_LEADS.forEach(s => {
                if (s.CATEGORIES) {
                    if (Array.isArray(s.CATEGORIES)) s.CATEGORIES.forEach(c => cats.add(c.trim()));
                    else s.CATEGORIES.split(',').forEach(c => cats.add(c.trim()));
                }
            });
            let html = '<b>Rubro</b><select id="catFilter"><option value="all">Todos</option>';
            Array.from(cats).sort().forEach(c => { html += `<option value="${c}">${c}</option>`; });
            html += '</select>';
            div.innerHTML = html;
            div.onchange = (e) => render(e.target.value);
            return div;
        };

        if (window.SCRAPED_LEADS) {
            render();
            filterControl.addTo(map);
        }

        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = () => {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `‚≠ê <b>Rating</b><br>
                <span class="dot" style="background:#22c55e"></span> 4.5+<br>
                <span class="dot" style="background:#eab308"></span> 4.0+<br>
                <span class="dot" style="background:#ef4444"></span> < 4.0`;
            return div;
        };
        legend.addTo(map);
    </script>
</body>
</html>