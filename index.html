<!DOCTYPE html>
<html>
<head>
    <title>scRappi BI - Hunting Argentina</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        #map { height: 100vh; width: 100%; background: #f0f2f5; }
        body { margin: 0; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        .brand-watermark {
            position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(255, 255, 255, 0.9);
            padding: 4px 12px; border-radius: 20px; border: 1px solid #ff4d4d;
            font-size: 9px; color: #ff4d4d; font-weight: bold; pointer-events: none;
            text-transform: uppercase; letter-spacing: 1px;
        }

        .legend {
            background: white; padding: 12px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); line-height: 1.6;
            font-size: 11px; color: #333; border: 1px solid #eee; min-width: 160px;
        }
        
        .locate-btn {
            background: #fff; width: 38px; height: 38px; line-height: 38px;
            text-align: center; border-radius: 50%; cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 18px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #ff4d4d; color: #ff4d4d; margin-bottom: 10px;
        }

        .legend b { display: block; margin-bottom: 5px; color: #000; font-size: 12px; }
        .dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; border: 1px solid #fff; }
        .platform-ring { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; vertical-align: middle; }
        
        .count-badge {
            float: right; background: #f1f5f9; color: #475569;
            padding: 0px 6px; border-radius: 10px; font-weight: 700;
            font-size: 10px; margin-left: 10px;
        }

        .popup-card { min-width: 200px; padding: 5px; }
        .popup-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; gap: 8px; }
        .popup-title { font-weight: 700; font-size: 14px; color: #1a1a1a; line-height: 1.2; flex: 1; }
        .popup-badge { font-size: 9px; padding: 2px 6px; border-radius: 6px; text-transform: uppercase; font-weight: 800; white-space: nowrap; }
        .popup-text { margin: 4px 0; font-size: 12px; color: #4b5563; }
        
        .btn-wa {
            display: block; width: 100%; background: #25D366; color: white !important;
            text-align: center; padding: 8px; border-radius: 8px; margin-top: 10px;
            text-decoration: none; font-weight: 600; font-size: 12px;
        }

        select, button.map-toggle { width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ddd; font-size: 11px; margin-top: 4px; outline: none; cursor: pointer; }
        button.map-toggle { background: #f8fafc; font-weight: 600; }
        button.map-toggle.active { background: #ff4d4d; color: white; border-color: #ff4d4d; }
    </style>
</head>
<body>

    <div id="map"></div>
    <div class="brand-watermark">HUNTING ARGENTINA - Intelligence Suite</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="mapa_leads.js"></script>

    <script>
        const map = L.map('map', { zoomControl: false }).setView([0, 0], 2);
        L.control.zoom({ position: 'bottomleft' }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        
        const markers = L.layerGroup().addTo(map);
        let heatLayer = null;
        let showHeat = false;

        // --- GPS ---
        let userMarker = null;
        const locateControl = L.control({ position: 'bottomright' });
        locateControl.onAdd = function() {
            const div = L.DomUtil.create('div', 'locate-btn');
            div.innerHTML = 'üìç'; 
            div.onclick = function(e) {
                e.stopPropagation();
                map.locate({ setView: true, maxZoom: 16 });
            };
            return div;
        };
        locateControl.addTo(map);

        map.on('locationfound', (e) => {
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker(e.latlng, {
                radius: 10, fillColor: '#3b82f6', color: '#fff', weight: 3, fillOpacity: 1
            }).addTo(map).bindPopup("Est√°s aqu√≠").openPopup();
        });

        function getWaLink(phone) {
            if (!phone || phone === "N/A") return null;
            let clean = phone.replace(/\D/g, '');
            if (clean.length === 10) clean = "549" + clean;
            return `https://wa.me/${clean}`;
        }

        function createMarker(shop) {
            const url = (shop.URL || "").toLowerCase();
            const rating = parseFloat(shop.RATING || 0);
            let lat = parseFloat(shop.LAT || shop.lat || 0);
            let lng = parseFloat(shop.LNG || shop.lng || 0);

            if (isNaN(lat) || lat === 0) return null;

            const fillCol = rating >= 4.5 ? '#22c55e' : rating >= 4.0 ? '#eab308' : '#ef4444';
            let strokeCol = "#888"; 
            let platformName = "PedidosYa";
            let weight = 2;

            if (url.includes("ubereats.com")) { strokeCol = "#000000"; platformName = "Uber Eats"; weight = 4; }
            else if (url.includes("didiglobal.com")) { strokeCol = "#ff8c00"; platformName = "DiDi Food"; weight = 4; }

            const marker = L.circleMarker([lat, lng], {
                radius: 8, fillColor: fillCol, color: strokeCol, weight: weight, fillOpacity: 0.9
            });

            const popupContent = `
                <div class="popup-card">
                    <div class="popup-header">
                        <span class="popup-title">${shop.NAME}</span>
                        <span class="popup-badge" style="background:${strokeCol}; color:white;">${platformName}</span>
                    </div>
                    <p class="popup-text">üìç ${shop.ADDRESS || 'Sin direcci√≥n'}</p>
                    <p class="popup-text">‚≠ê <b>${rating}</b></p>
                    ${getWaLink(shop.PHONE) ? `<a href="${getWaLink(shop.PHONE)}" target="_blank" class="btn-wa">üì± WhatsApp</a>` : ''}
                </div>
            `;
            return { marker: marker.bindPopup(popupContent), lat, lng };
        }

        function render(catFilter = 'all', platFilter = 'all') {
            markers.clearLayers();
            if (heatLayer) map.removeLayer(heatLayer);
            
            let bounds = [];
            let heatData = [];
            let counts = { peya: 0, uber: 0, didi: 0, total: 0 };

            if (typeof window.SCRAPED_LEADS === 'undefined') return;

            window.SCRAPED_LEADS.forEach(shop => {
                const url = (shop.URL || "").toLowerCase();
                let lat = parseFloat(shop.LAT || shop.lat || 0);
                let lng = parseFloat(shop.LNG || shop.lng || 0);
                if (isNaN(lat) || lat === 0) return;

                let matchCat = catFilter === 'all' || (shop.CATEGORIES || "").toString().toLowerCase().includes(catFilter.toLowerCase());
                
                let isU = url.includes('ubereats');
                let isD = url.includes('didiglobal');
                let isP = !isU && !isD;

                let matchPlat = platFilter === 'all' || 
                    (platFilter === 'uber' && isU) ||
                    (platFilter === 'didi' && isD) ||
                    (platFilter === 'peya' && isP);

                if (matchCat && matchPlat) {
                    const result = createMarker(shop);
                    if (result) {
                        result.marker.addTo(markers);
                        bounds.push([result.lat, result.lng]);
                        
                        // Intensidad del calor basada en Rating
                        let intensity = parseFloat(shop.RATING) / 5;
                        heatData.push([result.lat, result.lng, intensity || 0.5]);

                        if (isU) counts.uber++;
                        else if (isD) counts.didi++;
                        else counts.peya++;
                        counts.total++;
                    }
                }
            });

            // Crear capa de calor
            heatLayer = L.heatLayer(heatData, {
                radius: 25,
                blur: 15,
                maxZoom: 17,
                gradient: {0.4: 'blue', 0.6: 'cyan', 0.7: 'lime', 0.8: 'yellow', 1: 'red'}
            });

            if (showHeat) heatLayer.addTo(map);

            document.getElementById('count-total').innerText = counts.total;
            document.getElementById('count-uber').innerText = counts.uber;
            document.getElementById('count-didi').innerText = counts.didi;
            document.getElementById('count-peya').innerText = counts.peya;

            if (bounds.length > 0 && !userMarker) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        const filterControl = L.control({ position: 'topright' });
        filterControl.onAdd = function() {
            const div = L.DomUtil.create('div', 'legend');
            let cats = new Set();
            if (window.SCRAPED_LEADS) {
                window.SCRAPED_LEADS.forEach(s => {
                    if (s.CATEGORIES) {
                        const cList = Array.isArray(s.CATEGORIES) ? s.CATEGORIES : s.CATEGORIES.split(',');
                        cList.forEach(c => cats.add(c.trim()));
                    }
                });
            }
            div.innerHTML = `
                <b>üè¢ Plataforma</b><select id="platFilter"><option value="all">Todas</option><option value="peya">PedidosYa</option><option value="uber">Uber Eats</option><option value="didi">DiDi Food</option></select>
                <br><br><b>üçï Rubro</b><select id="catFilter"><option value="all">Todos</option>${Array.from(cats).sort().map(c => `<option value="${c}">${c}</option>`).join('')}</select>
                <br><br><button id="heatToggle" class="map-toggle">üî• Mapa de Calor: OFF</button>
            `;
            
            // L√≥gica del bot√≥n de calor
            div.querySelector('#heatToggle').onclick = function() {
                showHeat = !showHeat;
                this.innerText = `üî• Mapa de Calor: ${showHeat ? 'ON' : 'OFF'}`;
                this.classList.toggle('active');
                if (showHeat) heatLayer.addTo(map); else map.removeLayer(heatLayer);
            };

            div.onchange = () => render(document.getElementById('catFilter').value, document.getElementById('platFilter').value);
            return div;
        };

        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = () => {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <b>üìä Market Share (<span id="count-total">0</span>)</b>
                <span class="platform-ring" style="border: 2px solid #000"></span> Uber Eats <span class="count-badge" id="count-uber">0</span><br>
                <span class="platform-ring" style="border: 2px solid #ff8c00"></span> DiDi Food <span class="count-badge" id="count-didi">0</span><br>
                <span class="platform-ring" style="border: 2px solid #888"></span> PedidosYa <span class="count-badge" id="count-peya">0</span>
                <hr style="margin:8px 0; border:0; border-top:1px solid #eee;">
                <b>‚≠ê Calidad (Rating)</b>
                <span class="dot" style="background:#22c55e"></span> 4.5+ (Top)<br>
                <span class="dot" style="background:#eab308"></span> 4.0+ (Bueno)<br>
                <span class="dot" style="background:#ef4444"></span> < 4.0 (Bajo)
            `;
            return div;
        };

        if (window.SCRAPED_LEADS) {
            legend.addTo(map);
            filterControl.addTo(map);
            render();
        }
    </script>
</body>
</html>